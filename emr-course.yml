Description: >-
  CloudFormation template to create Amazon EMR cluster for student and coursework. The script can deploy a reverse proxy 
  with basic authentication enabled on the master node to enforce authenticated access to Livy for remote spark sessions.
  An additional bootstrap script can also be executed. 
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Amazon EMR Cluster Configuration
        Parameters:
          - ReleaseLabel
          - InstanceType
          - VpcId
          - VPCPublicSubnet
          - EC2KeyPair
          - BootstrapProxyScript
          - BootstrapMasterAdditionsScript
          - BootstrapOtherAdditionsScript
      - Label:
          default: Livy Proxy Credentials
          Parameters:
            - Username
            - Password
            - Password2
    ParameterLabels:
      ReleaseLabel:
        default: EMR Release Label
      VPCPublicSubnet:
        default: VPC Public Subnet
      EC2KeyPair:
        default: EC2 Key Pair
      BootstrapProxyScript:
        default: Proxy Bootstrap Script
      BootstrapMasterAdditionsScript:
        default: Master Bootstrap Script
      BootstrapOtherAdditionsScript:
        default: Non-master Bootstrap Script        

Parameters:
  EC2KeyPair:
    Description: Amazon EC2 Key Pair
    Type: AWS::EC2::KeyPair::KeyName

  ReleaseLabel:
    Type: String
    Default: "emr-6.2.0"
    AllowedValues:
    - "emr-6.2.0"
    - "emr-5.32.0"
    Description: Amazon EMR Version
  VPCPublicSubnet:
    Type: 'AWS::EC2::Subnet::Id'
    Description: >-
      Public Subnet to be used for Amazon EMR cluster. 
    AllowedPattern: .+
  InstanceType:
    Type: String
    Default: m5.xlarge
    AllowedValues:
    - m5.xlarge
    - m6g.xlarge
    Description: Amazon EMR Cluster Instance Type
  Username:
    Type: String
    Default: 'livy'
    ConstraintDescription: "Letters, numbers, dashes, and underscores only"
    AllowedPattern: ^[a-zA-Z0-9_.-]*$
  Password:
    Type: String
    NoEcho: True
    Description: Enter a password
    ConstraintDescription: "Letters, numbers, dashes, and underscores only"
    AllowedPattern: ^[a-zA-Z0-9_.-]*$    
  Password2:
    Type: String
    NoEcho: True
    Description: Enter a password again

  
  
  BootstrapProxyScript:
    Type: String
    Description: URL to the bootstrap script that will be used to install a proxy on the master node.
    Default: https://raw.githubusercontent.com/senorkrabs/aws-emr-course-bootstrap/master/bootstrap-nginx.sh
  
  BootstrapMasterAdditionsScript:
    Type: String
    Description: (Optional) URL to an additional bootstrap script that can be used for running commands on master nodes. 
    Default: ''
  
  BootstrapOtherAdditionsScript:
    Type: String
    Description: (Optional) URL to an additional bootstrap script that can be used for running commands on non-master nodes. 
    Default: ''    

  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: VpcId of your existing Virtual Private Cloud (VPC)
    ConstraintDescription: Must be the VPC Id of an existing Virtual Private Cloud.

Rules:
  SubnetsInVPC:
    Assertions:
      - Assert:
          'Fn::Equals':
            - 'Fn::ValueOf':
                - 'VPCPublicSubnet'
                - 'VpcId'
            - !Ref VpcId
        AssertDescription: All subnets must in the VPC
      - Assert:
          'Fn::Equals':
            - !Ref Password
            - !Ref Password2
        AssertDescription: Passwords must match.
    
Conditions:
  BootstrapMasterAdditions: !Not [!Equals [!Ref BootstrapMasterAdditionsScript, '']]
  BootstrapOtherAdditions: !Not [!Equals [!Ref BootstrapOtherAdditionsScript, '']]



Resources:

  LivyProxyCredentials:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: !Sub ${AWS::StackName}-LivyCredentials
      Description: This secret has a hardcoded password in SecretString (use GenerateSecretString instead)
      SecretString: !Sub '{"username":"${Username}","password":"${Password}"}'

  LivyProxyCredentialsResourcePolicy:
    Type: AWS::SecretsManager::ResourcePolicy
    Properties:
      BlockPublicPolicy: True
      SecretId:
        Ref: LivyProxyCredentials
      ResourcePolicy:
        Version: '2012-10-17'
        Statement:
        - Resource: "*"
          Action: secretsmanager:GetSecretValue
          Effect: Allow
          Principal:
            AWS:
              Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/EMR_EC2_DefaultRole

  EMRCluster:
    Type: 'AWS::EMR::Cluster'
    Properties:
      Instances:
        MasterInstanceGroup:
          InstanceCount: 1
          InstanceType: !Ref InstanceType
          Market: ON_DEMAND
          Name: cfnMaster
        CoreInstanceGroup:
          InstanceCount: 1
          InstanceType: !Ref InstanceType
          Market: ON_DEMAND
          Name: cfnCore
        Ec2SubnetId: !Ref VPCPublicSubnet
        Ec2KeyName: !Ref EC2KeyPair
        AdditionalMasterSecurityGroups:
          - !Ref HTTPIngressSecurityGroup
      Name: course-emr-cluster
      BootstrapActions:
        - !If 
            - BootstrapMasterAdditions
            - Name: BootstrapMasterAdditions
              ScriptBootstrapAction:
                Path: s3://elasticmapreduce/bootstrap-actions/run-if
                Args: 
                  - instance.isMaster=true
                  - !Sub /bin/bash -c "$(curl -fsSL ${BootstrapMasterAdditionsScript})" 
            - !Ref AWS::NoValue           
        - !If 
            - BootstrapOtherAdditions
            - Name: BootstrapOtherAdditions
              ScriptBootstrapAction:
                Path: s3://elasticmapreduce/bootstrap-actions/run-if
                Args: 
                  - instance.isMaster=false
                  - !Sub /bin/bash -c "$(curl -fsSL ${BootstrapOtherAdditionsScript})" 
            - !Ref AWS::NoValue
           
      Applications:
        - Name: Hadoop
        - Name: Spark
        - Name: Livy
        - Name: Zeppelin
        - Name: JupyterEnterpriseGateway
      JobFlowRole: EMR_EC2_DefaultRole
      ServiceRole: EMR_DefaultRole
      ReleaseLabel: !Ref ReleaseLabel
      VisibleToAllUsers: true
      LogUri: 
        Fn::Sub: 's3://${EMRLogsBucket}/elasticmapreduce/'
  EMRLogsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  EMRCopyNotebooksStep:
    Type: 'AWS::EMR::Step'
    Properties:
      ActionOnFailure: CONTINUE
      HadoopJarStep:
        Args:
          - "/bin/bash"
          - "-c"
          - !Sub "curl -fsSL ${BootstrapProxyScript} | bash -s ${AWS::StackName}-LivyCredentials"
        Jar: 'command-runner.jar'
        MainClass: ''
      Name: BootstrapLivyProxy
      JobFlowId: !Ref EMRCluster

  HTTPIngressSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
        GroupDescription: Allow http to client host
        VpcId: !Ref VpcId
        SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0          
        SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0          
Outputs:
  EMRMasterNodeDNS:
    Description: EMR Cluster Master Node DNS
    Value: !Sub http://${EMRCluster.MasterPublicDNS}

